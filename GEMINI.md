# 株価データ分析ツール (Gemini用コンテキスト)

## プロジェクト概要
指定した複数の株式ティッカーシンボルについて、株価データを自動取得・分析し、テクニカル指標に基づく投資判断シグナルと総合スコアを出力するPythonツールです。
本プロジェクトは、平日に定時実行されるAI分析、TypeScriptによるフロントエンド、メール通知、AIによる自動パフォーマンスレビューと**動的パラメータチューニング**、そしてフロントエンドでのグラフ描画といった機能を備えたフルスタックアプリケーションの開発を目的としています。
GeminiエージェントのAI支援によって、コード実装の補助および機能拡張の提案を受けることを目的としています。

---

## 機能要件
- **データ取得・分析**: 指定されたティッカーリストに基づき、株価データをダウンロードし、テクニカル指標とスコアを計算する。
- **分析パラメータの動的管理**:
  - テクニカル分析に使用するパラメータ（閾値など）を、**日付ごとにバージョン管理**してデータベースに保存する。
  - 分析実行時は、**最新の日付**のパラメータセットを自動的に使用する。
- **データベースへの保存**: 計算した指標、シグナル、スコア、および使用したパラメータセットをPostgreSQLデータベースに保存する。
- **非同期分析実行API (`POST /analyze/run`)**:
  - 分析プロセス全体をバックグラウンドで実行する。
  - リクエストを受け付けると、実際の処理を待たずに即座に応答を返す。
- **フィルタリング・検索API (`GET /stocks/search`)**:
  - データベースに保存された最新の分析結果を対象とする。
  - スコア、ソート順などの条件に基づき、銘柄をフィルタリングしてJSON形式で出力する。
  - 検索結果には、企業の詳細情報（事業概要など）を付与する。
- **ログ出力**:
  - バックエンドの処理状況（APIリクエスト、分析の進捗、エラーなど）をログファイル (`data/logs/app.log`) に記録する。
- **フロントエンドアプリケーション**: TypeScriptとReactを用い、分析結果の閲覧やインタラクティブなグラフ表示を提供する。
- **（将来実装）AIによる自動チューニング**: AIが過去の投資判断を再評価し、チューニングパラメータを自動で更新する。
- **（将来実装）グラフ描画機能**: 銘柄の価格履歴と投資判断履歴を組み合わせたグラフデータを生成する。

---

## ディレクトリ構成

```
.
├── data/
├── src/
├── frontend/
├── Dockerfile
├── requirements.txt
├── README.md
└── GEMINI.md
```

---

## 実装方針

### 1. APIエンドポイント

バックエンドはFastAPIをベースとし、以下の2つの主要なAPIエンドポイントを提供します。

- **`POST /analyze/run`**:
  - **役割**: 株価分析タスクを非同期で開始します。
  - **処理**: リクエストを受け付けると、バックグラウンドで株価データの取得、テクニカル指標の計算、データベースへの結果保存までの一連の処理を実行します。
- **`GET /stocks/search`**:
  - **役割**: データベースに保存された分析結果を検索・フィルタリングします。
  - **処理**: スコアやソート順などのクエリパラメータに基づき、最新の分析結果から該当する銘柄データを取得し、企業情報を付加して返します。

### 2. 分析とデータベース保存 (`/analyze/run` の内部処理)

#### 2.1. チューニングパラメータの取得
- 分析ロジックは、まずデータベースに接続し、`tuning_parameters`テーブルから**最新の日付**を持つパラメータセットを読み込みます。
- パラメータが存在しない場合は、現在の日付でデフォルト値をDBに保存し、それを使用します。

#### 2.2. データ取得とテクニカル指標計算
- `data/csv/tickers.csv`から銘柄リストを読み込み、`yfinance`を用いて株価データを取得します。
- 取得したパラメータセットを使い、各銘柄のテクニカル指標（RSI, MACDなど）とスコアを計算します。

#### 2.3. データベースへの保存
- まず、今回の分析実行情報を`analysis_runs`テーブルに1レコード作成します。このレコードには実行日時と使用したパラメータのJSONが保存されます。
- 次に、銘柄ごとの分析結果を`analysis_results`テーブルに保存します。各レコードは、先ほど作成した`analysis_runs`レコードのIDを外部キーとして持ちます。

### 3. 検索とフィルタリング (`/stocks/search` の内部処理)

#### 3.1. データベースからのデータ取得
- `analysis_runs`テーブルから最新の実行記録を1件取得します。
- その実行IDに紐づく全ての`analysis_results`レコードをクエリ対象とします。
- `min_buy_score`や`sort_by`などのクエリパラメータに基づき、SQLAlchemyを用いてフィルタリングとソートを行います。

#### 3.2. 企業情報の付与
- データベースから取得した銘柄リストに対し、`yfinance`を利用して企業の詳細情報（Webサイト、事業概要など）を取得し、各銘柄のデータに付与します。

#### 3.3. レスポンスの生成
- 全ての情報を付与した銘柄データのリストをJSON形式で返します。レスポンスの例は以下の通りです。

```json
{
  "message": "Found 50 stocks.",
  "analysis_results": [
    {
      "id": 123,
      "analysis_run_id": 10,
      "ticker": "XXXX.T",
      "price": 1500.0,
      "rsi": 24.5,
      "deviation_rate_25": -6.8,
      "trend": "Upward",
      "macd_line": 10.5,
      "macd_signal": 8.2,
      "dmi_dmp": 28.1,
      "dmi_dmn": 15.6,
      "adx": 26.2,
      "volume": 1234500,
      "signals": { "..."},
      "buy_score": 8,
      "short_score": 0,
      "analyzed_at": "2025-11-10T12:00:00Z",
      "parameters_used": {
        "rsi_length": 14,
        "date": "2025-11-10"
      },
      "info": {
        "website": "https://example.com",
        "longBusinessSummary": "..."
      }
    }
  ]
}
```

### 4. ログ設定
- アプリケーションのログは、`src/main.py`で一元的に設定されます。
- 出力先はコンソールと`data/logs/app.log`ファイルの両方です。
- ログはファイルサイズに応じてローテーションされ、過去5世代分が保持されます。

